<script>
const addImportedImageToCanvas = {

   getText : function(clickedImage){
     var idInputElement = "img-name-"+ clickedImage.target.id.replace('img-','');
     if(document.getElementById(idInputElement)) {
     this.clickedImageId = clickedImage.target.id;
     this.text = document.getElementById(idInputElement).value
     
     };
     return this.text;
   },
   
   updateCanvasWithJSON: function (clickedImage){
     return new Promise(function(resolve, reject){
     
     var element = document.getElementById(clickedImage)    
     canvasJSON = JSON.parse(element.dataset.forcanvas);
     console.log('This is the canvas JSON:', canvasJSON)
     if(canvasJSON.data === ''){
       resolve('not done')
     }
     canvas.clear();
     canvas.loadFromJSON(canvasJSON.data, canvas.renderAll.bind(canvas), function(){
       resolve('done')
     });
     })
   },

   getImageToAdd : function(clickedImage){
       var that = this;
       this.updateCanvasWithJSON(clickedImage.target.id).then(function(result){
         if(result === 'not done'){
            that.getText(clickedImage);
            that.prepareImageForCanvas(clickedImage.target.src);
            return this.text;         
         }
       })
   }, 
   
   prepareImageForCanvas : function(src){
      var that = this;
      this.getBase64(src).then(function(result){
        const element = document.createElement('img');
        element.src = result;
        that.addImageToCanvas(element);
      })
    }, 
    
    text: '',
    clickImageId: '',
    
    
    addImageToCanvas: function(image){ 
      var that = this;
      fabric.Image.fromURL(image.src, function(img) {    
        img.set({ left: 0, top:0,}).scale(270/image.width).applyFilters();
        canvas.clear().add(img);  
        textEditor.addHiddenLabel([that.text, that.clickedImageId]);
        textEditor.addText(that.text);      
        textEditor.setObjectStyle();
      }); 
    }, 
    getBase64 : function(url){
      var that = this;
      return new Promise(function (resolve, reject){
        var xmlHTTP = new XMLHttpRequest();
          xmlHTTP.open('GET', url, true);
          xmlHTTP.responseType = 'arraybuffer';
          xmlHTTP.onload = function(e) {        
            var dataURL="data:image/png;base64," + that.createB64String(this.response);
            resolve(dataURL);
        };
        xmlHTTP.send();
      })
    },
    
    createB64String: function (returnedData){
     return btoa(new Uint8Array(returnedData).reduce(function (data, byte) {
        return data + String.fromCharCode(byte);
      }, ''));    
    } 
}


</script>